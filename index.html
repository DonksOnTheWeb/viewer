<!DOCTYPE html>
<html>
<head>
    <title>KML Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css" type="text/css">
	<script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .map {
            height: 900px;
            width: 100%;
        }

        /* Add style for tooltip div */
        .tooltip {
            position: absolute;
            background-color: #f9f9f9;
            border: 1px solid #c0c0c0;
            border-radius: 5px;
            padding: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>
</head>
<body>
    <h2>David's 1337 Map.</h2>
    <div id="map" class="map"></div>
    <textarea id="kml_input" placeholder="Paste your KML string here"></textarea>
    <button onclick="loadKML()">Load KML</button>
    <div id="tooltip" class="tooltip"></div> <!-- Add tooltip div -->

	<div id="g_id_onload"
		 data-client_id="278292245850-kj2jibr3r54rqnnfifq2jsag3h1qq7ks.apps.googleusercontent.com"
		 data-callback="handleCredentialResponse">
	</div>
	<div class="g_id_signin" data-type="standard"></div>

    <script type="text/javascript">
        var map = new ol.Map({
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            target: 'map',
            view: new ol.View({
                center: [0, 0],
                zoom: 2
            })
        });

        // Create tooltip element
        var tooltip = document.getElementById('tooltip');

		function handleCredentialResponse(response) {
		  var payload = response.getPayload();
		  var email = payload.email;
		  var domain = email.split('@')[1];

		  var allowedDomains = ['yourdomain.com'];  // Replace with your own domain(s)
		  if (allowedDomains.includes(domain)) {
			console.log('User is from an allowed domain');
			// You can add more logic here to handle successful sign-in from allowed domain
		  } else {
			console.log('User is not from an allowed domain');
			// Handle sign-in from disallowed domain (e.g., show an error message)
		  }
		}


        function loadKML() {
		
			var fileID = "14BnOoG7Z_Md5KhWslE0C3ZMWSxCkHGRp"; // Replace with your file ID.
			var url = "https://script.google.com/a/macros/gopuff.com/s/AKfycby6EyTiJC6aR17u4-zjt5Oqw2rI4RHQgNtCxDlvge7GNlXdq4vIeDPus7hVIJyGqokF/exec?id=" + fileID; // Replace with your web app URL.

			// Fetch KML data from Google Drive via Google Apps Script
			var response = await fetch(url);
			
			if (!response.ok) {
				alert("HTTP error " + response.status);
				return;
			}
			
			var kmlString = await response.text();
		
            var kmlFormat = new ol.format.KML();

            var features = kmlFormat.readFeatures(kmlString, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:3857'
            });
			console.log(features)
            var vectorSource = new ol.source.Vector({
                features: features
            });

            var vectorLayer = new ol.layer.Vector({
                source: vectorSource
            });
			
            vectorLayer.set('id', 'hexLayer');
			vectorLayer.setZIndex(1);

            map.addLayer(vectorLayer);

            var extent = vectorSource.getExtent();
            map.getView().fit(extent, map.getSize());

            // Add mousemove event listener to display tooltip
            map.on('pointermove', function (event) {
                var hexFeatures = map.getFeaturesAtPixel(event.pixel, {
                    layerFilter: function (layer) {
                        return layer.get('id') === 'hexLayer';
                    }
                });

                if (hexFeatures.length > 0 && hexFeatures[0].get('class') === 'hex-placemark') {
                    var description = hexFeatures[0].get('description');
                    
                    // Update tooltip content and display it
                    tooltip.textContent = description;
                    tooltip.style.opacity = 1;
                    
                    // Update tooltip position
                    var coordinate = event.coordinate;
                    var pixel = map.getPixelFromCoordinate(coordinate);
                    tooltip.style.left = pixel[0] + 10 + 'px';
                    tooltip.style.top = pixel[1] - 25 + 'px';
                } else {
                    // Hide tooltip
                    tooltip.style.opacity = 0;
                }
            });
        }
    </script>
</body>
</html>
